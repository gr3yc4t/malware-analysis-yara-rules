import "pe"


rule time_check {
    meta:
        author="gr3yc4t"
        description = "The malware checks the current time"
    strings:
        $functionName = "GetLocalTime"

        //Dynamic load
        $getHandle = "GetModuleHandle"

    condition:
        (
            $functionName 
            and
            (
                pe.imports("kernel32.dll", "GetModuleHandleA")
                or
                $getHandle
            )
            
        )
        or
        pe.imports("kernel32.dll", "GetLocalTime")
}



rule computer_name_info{
    meta:
        author="gr3yc4t"
        description = "The malware checks the computer name"   
    strings:
        $functionName = "GetComputerName"

        //Dynamic load
        $getHandle = "GetModuleHandle"

    condition:
        (
            $functionName 
            and
            (
                pe.imports("kernel32.dll", "GetModuleHandleA")
                or
                $getHandle
            )
            
        )
        or
        pe.imports("kernel32.dll", "GetComputerNameA")
}


rule check_mutex {
    meta:
        author="gr3yc4t"
        description = "The malware checks the presence of a mutex" 
    strings:
        $createMutex = "CreateMutexA"
        $AlreadyExistsCode = { B7}
        $getLastError = "GetLastError"
}


rule check_adapter_address{
    meta:
        author="gr3yc4t"
        description="Check if the malware fetch network adapter's IP address"
    strings:
        $getAdapter = "GetAdapterAddress"

        $dynamicLoad = "GetModuleHandle"
    condition:
        //Dynamic Loading
        (
            $getAdapter 
            and
            (
                pe.imports("kernel32.dll", "GetModuleHandleA")
                or
                $dynamicLoad
            )
        )
        or
        //Classical Import
        pe.imports("kernel32.dll", "GetAdapterAddress")
}


